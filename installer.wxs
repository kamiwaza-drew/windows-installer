<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" 
             Name="Kamiwaza Installer $(var.KAMIWAZA_VERSION) ($(var.ARCH))" 
             Language="1033" 
             Version="1.0.0.0" 
             Manufacturer="Kamiwaza" 
             UpgradeCode="12345678-1234-1234-1234-123456789012">
        
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perMachine" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <Feature Id="ProductFeature" Title="KamiwazaInstaller" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
        </Feature>

        <!-- Properties for WSL memory configuration and versioning -->
        <Property Id="WSLMEMORY" Value="14GB" />
        <Property Id="KAMIWAZA_VERSION" Value="$(var.KAMIWAZA_VERSION)" />
        <Property Id="CODENAME" Value="$(var.CODENAME)" />
        <Property Id="BUILD_NUMBER" Value="$(var.BUILD_NUMBER)" />
        <Property Id="ARCH" Value="$(var.ARCH)" />
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
        <WixVariable Id="WixUICostingPopupOptOut" Value="1" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Kamiwaza Installer" />
        
        <!-- Custom Action to launch installer with memory and version parameters -->
        <CustomAction Id="LaunchKamiwaza"
            Directory="INSTALLFOLDER"
            ExeCommand="kamiwaza_installer.exe --memory=[WSLMEMORY] --version=[KAMIWAZA_VERSION] --codename=[CODENAME] --build=[BUILD_NUMBER] --arch=[ARCH]"
            Return="asyncNoWait"
            Impersonate="yes" />

        <!-- Define the directory structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="Kamiwaza">
                    <!-- MainExecutable component removed -->
                </Directory>
            </Directory>
            <!-- Start Menu -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Kamiwaza">
                    <Component Id="ApplicationShortcut" Guid="8B6A1B2C-3D4E-5F60-7A8B-9C0D1E2F3A4B">
                        <Shortcut Id="ApplicationStartMenuShortcut" 
                                 Name="Kamiwaza Installer" 
                                 Description="Kamiwaza Installation Tool" 
                                 Target="[INSTALLFOLDER]kamiwaza_installer.exe" 
                                 WorkingDirectory="INSTALLFOLDER" />
                        <Shortcut Id="ApplicationStartMenuShortcutDev" 
                                 Name="Kamiwaza Installer (Developer Mode)" 
                                 Description="Kamiwaza Installation Tool (Debug Mode)" 
                                 Target="[INSTALLFOLDER]kamiwaza_installer.exe" 
                                 WorkingDirectory="INSTALLFOLDER"
                                 Arguments="--debug" />
                        <RemoveFolder Id="CleanUpShortCut" 
                                    Directory="ApplicationProgramsFolder" 
                                    On="uninstall" />
                        <RegistryValue Root="HKCU" 
                                     Key="Software\Kamiwaza\KamiwazaInstaller" 
                                     Name="installed" 
                                     Type="integer" 
                                     Value="1" 
                                     KeyPath="yes" />
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <!-- Download EXE from R2 at install time -->
        <Property Id="EXE_URL" Value="https://pub-3feaeada14ef4a368ea38717abd3cf7e.r2.dev/kamiwaza_installer_$(var.KAMIWAZA_VERSION)_$(var.ARCH)_build$(var.BUILD_NUMBER).exe" />
        <CustomAction Id="DownloadKamiwazaExe"
            Directory="INSTALLFOLDER"
            ExeCommand="powershell -NoProfile -ExecutionPolicy Bypass -Command &quot;try { Write-Host 'Downloading from [EXE_URL]'; Invoke-WebRequest -Uri '[EXE_URL]' -OutFile 'kamiwaza_installer.exe' -UseBasicParsing; Write-Host 'Download completed successfully'; exit 0 } catch { Write-Host 'Download failed:' $_.Exception.Message; exit 1 }&quot;"
            Execute="deferred"
            Return="check"
            Impersonate="no" />

        <InstallExecuteSequence>
            <Custom Action="DownloadKamiwazaExe" Before="CreateShortcuts">NOT Installed</Custom>
        </InstallExecuteSequence>

        <!-- Define the components -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <!-- <ComponentRef Id="MainExecutable" /> removed -->
            <ComponentRef Id="ApplicationShortcut" />
        </ComponentGroup>

        <!-- Custom UI with memory configuration dialog -->
        <UIRef Id="WixUI_InstallDir" />
        <UI>
          <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchKamiwaza">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1</Publish>
        </UI>
    </Product>
</Wix> 