<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" 
             Name="Kamiwaza" 
             Language="1033" 
             Version="$(var.KAMIWAZA_VERSION_MAJOR).$(var.KAMIWAZA_VERSION_MINOR).$(var.KAMIWAZA_VERSION_PATCH).0" 
             Manufacturer="Kamiwaza" 
             UpgradeCode="12345678-1234-1234-1234-123456789012">
        
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perUser" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <!-- Add icon reference -->
        <Icon Id="KamiwazaIcon" SourceFile="kamiwaza.ico" />
        
        <!-- Use Kamiwaza icon for Add/Remove Programs -->
        <Property Id="ARPPRODUCTICON" Value="KamiwazaIcon" />

        <Feature Id="ProductFeature" Title="KamiwazaInstaller" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
        </Feature>

        <!-- Properties for WSL memory configuration and versioning -->
        <Property Id="WSLMEMORY" Value="14GB" />
        <Property Id="KAMIWAZA_VERSION" Value="$(var.KAMIWAZA_VERSION)" />
        <Property Id="CODENAME" Value="$(var.CODENAME)" />
        <Property Id="BUILD_NUMBER" Value="$(var.BUILD_NUMBER)" />
        <Property Id="ARCH" Value="$(var.ARCH)" />
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        
        <!-- Additional user configuration properties -->
        <Property Id="USER_EMAIL" Secure="yes" />
        <Property Id="LICENSE_KEY" Secure="yes" />
        <Property Id="USAGE_REPORTING" Value="1" />
        <Property Id="INSTALL_MODE" Value="lite" />
        <Property Id="LAUNCH_GUI" Value="0" />
        
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
        <WixVariable Id="WixUICostingPopupOptOut" Value="1" />
        
        <WixVariable Id="WixUIDialogBmp" Value="logo.bmp"/>
        <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />

        <!-- Always enable verbose MSI logging to Temp -->
        <Property Id="MsiLogging" Value="voicewarmupx!"/>
        
        <!-- Force verbose logging for debugging -->
        <Property Id="MSIEXEC_LOGGING" Value="/L*V &quot;%TEMP%\kamiwaza_install.log&quot;" />

        <!-- Define the directory structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="Kamiwaza">
                    <!-- Embedded Python Runtime Directory -->
                    <Directory Id="PYTHONFOLDER" Name="python" />
                    <Component Id="KamiwazaInstallerFiles" Guid="9C7B2A3D-4E5F-6071-8B9C-0D1E2F3A4B5C">
                        <File Id="DownloadScriptFile" Name="download_exe.ps1" Source="download_exe.ps1"/>
                        <File Id="HeadlessInstaller" Name="kamiwaza_headless_installer.py" Source="kamiwaza_headless_installer_build.py"/>
                        <File Id="KamiwazaBatchWrapper" Name="run_kamiwaza.bat" Source="run_kamiwaza.bat"/>

                        <File Id="WSLConfigScript" Name="configure_wsl_memory.ps1" Source="configure_wsl_memory.ps1"/>
                        <File Id="DebconfSetupScript" Name="setup_debconf.sh" Source="setup_debconf.sh"/>
                        <File Id="PasswordlessSudoScript" Name="setup_passwordless_sudo.sh" Source="setup_passwordless_sudo.sh"/>
                        <File Id="ConfigFile" Name="config.yaml" Source="config.yaml"/>
                        <File Id="WSLCleanupScript" Name="cleanup_wsl_kamiwaza.ps1" Source="cleanup_wsl_kamiwaza.ps1"/>
                        <File Id="WSLCleanupBatch" Name="cleanup_installs.bat" Source="cleanup_installs.bat"/>
                        <File Id="GPUDetectionScript" Name="detect_gpu.ps1" Source="detect_gpu.ps1"/>
                        <File Id="GPUDetectionCMDScript" Name="detect_gpu_cmd.bat" Source="detect_gpu_cmd.bat"/>
                        <File Id="NvidiaSetupScript" Name="setup_nvidia_gpu.sh" Source="setup_nvidia_gpu.sh"/>
                        <File Id="IntelArcSetupScript" Name="setup_intel_arc_gpu.sh" Source="setup_intel_arc_gpu.sh"/>
                        <File Id="StartPlatformBatch" Name="start_platform.bat" Source="start_platform.bat"/>
                        <File Id="KamiwazaStartBatch" Name="kamiwaza_start.bat" Source="kamiwaza_start.bat"/>
                        <File Id="KamiwazaStopBatch" Name="kamiwaza_stop.bat" Source="kamiwaza_stop.bat"/>
                        <File Id="AutoStartBatch" Name="kamiwaza_autostart.bat" Source="kamiwaza_autostart.bat"/>
                        <File Id="CreateRunOnceBatch" Name="create_runonce.bat" Source="create_runonce.bat"/>
                        <File Id="CreateAutostartRegistry" Name="create_autostart_registry.ps1" Source="create_autostart_registry.ps1"/>
                        <File Id="KamiwazaGUIManager" Name="KamiwazaGUIManager.exe" Source="KamiwazaGUIManager.exe"/>
                        <File Id="InstallGUIManager" Name="install_gui_manager.ps1" Source="install_gui_manager.ps1"/>
                        <RegistryValue Root="HKCU" Key="Software\Kamiwaza\Installer" Name="installed" Type="string" Value="1" KeyPath="yes"/>
                        <!-- Removes the entire Kamiwaza installation folder -->
                        <RemoveFolder Id="RemoveKamiwazaFolder" Directory="INSTALLFOLDER" On="uninstall"/>
                        <!-- Removes specific file types -->
                        <RemoveFile Id="RemoveDownloadedExe" Directory="INSTALLFOLDER" Name="kamiwaza_installer*.exe" On="uninstall"/>
                        <RemoveFile Id="RemoveLogFiles" Directory="INSTALLFOLDER" Name="*.log" On="uninstall"/>
                        <RemoveFile Id="RemoveDebFiles" Directory="INSTALLFOLDER" Name="*.deb" On="uninstall"/>
                        <RemoveFile Id="RemoveTempFiles" Directory="INSTALLFOLDER" Name="*.tmp" On="uninstall"/>
                        <!-- Additional cleanup for WSL and debug files -->
                        <RemoveFile Id="RemoveDebugLogs" Directory="INSTALLFOLDER" Name="*debug*.log" On="uninstall"/>
                        <RemoveFile Id="RemoveWSLBackups" Directory="INSTALLFOLDER" Name=".wslconfig.backup.*" On="uninstall"/>
                        <RemoveFile Id="RemoveSpecFiles" Directory="INSTALLFOLDER" Name="*.spec" On="uninstall"/>
                        <RemoveFile Id="RemoveBackupFiles" Directory="INSTALLFOLDER" Name="*.backup*" On="uninstall"/>
                        <RemoveFile Id="RemoveConfigFiles" Directory="INSTALLFOLDER" Name=".wslconfig*" On="uninstall"/>
                        <RemoveFile Id="RemoveDownloadLogs" Directory="INSTALLFOLDER" Name="download*.log" On="uninstall"/>
                    </Component>
                </Directory>
            </Directory>
            <!-- Start Menu -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Kamiwaza">
                    <Component Id="ApplicationShortcut" Guid="8B6A1B2C-3D4E-5F60-7A8B-9C0D1E2F3A4B">
                        <Shortcut Id="InstallKamiwazaShortcut" 
                                 Name="Install Kamiwaza" 
                                 Description="Download and Install Kamiwaza with [WSLMEMORY] dedicated memory" 
                                 Target="[INSTALLFOLDER]run_kamiwaza.bat" 
                                 Arguments="--memory &quot;[WSLMEMORY]&quot; --email &quot;[USER_EMAIL]&quot; --license-key &quot;[LICENSE_KEY]&quot; --usage-reporting &quot;[USAGE_REPORTING]&quot; --mode &quot;[INSTALL_MODE]&quot;"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />
                                 
                        <Shortcut Id="StartPlatformShortcut" 
                                 Name="Start Platform" 
                                 Description="Launch Kamiwaza Platform in dedicated WSL instance" 
                                 Target="[INSTALLFOLDER]start_platform.bat"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="KamiwazaStartShortcut" 
                                 Name="Kamiwaza Start" 
                                 Description="Start Kamiwaza platform and show status (keeps CLI open)" 
                                 Target="[INSTALLFOLDER]kamiwaza_start.bat"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="KamiwazaStopShortcut" 
                                 Name="Kamiwaza Stop" 
                                 Description="Stop Kamiwaza platform and show status (keeps CLI open)" 
                                 Target="[INSTALLFOLDER]kamiwaza_stop.bat"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="CleanupWSLShortcut" 
                                 Name="Uninstall Kamiwaza" 
                                 Description="Completely remove Kamiwaza WSL instances and data" 
                                 Target="powershell.exe" 
                                 Arguments="-ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]cleanup_wsl_kamiwaza.ps1&quot; -Force"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="CleanupWSLBatchShortcut" 
                                 Name="Uninstall Kamiwaza (App + Data)" 
                                 Description="Completely remove Kamiwaza WSL instances and data (Batch version)" 
                                 Target="[INSTALLFOLDER]cleanup_installs.bat"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="SetupAutostartShortcut" 
                                 Name="Setup GPU Autostart" 
                                 Description="Configure Kamiwaza to start automatically after system restart (for GPU acceleration)" 
                                 Target="powershell.exe" 
                                 Arguments="-ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]create_autostart_registry.ps1&quot;"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <Shortcut Id="KamiwazaMonitorShortcut" 
                                 Name="Kamiwaza Monitor" 
                                 Description="Launch Kamiwaza Monitor - GUI Management Tool" 
                                 Target="[INSTALLFOLDER]KamiwazaGUIManager.exe"
                                 WorkingDirectory="INSTALLFOLDER"
                                 Icon="KamiwazaIcon"
                                 IconIndex="0" />

                        <RemoveFolder Id="CleanUpShortCut" 
                                    Directory="ApplicationProgramsFolder" 
                                    On="uninstall" />
                        <RegistryValue Root="HKCU" 
                                     Key="Software\Kamiwaza\KamiwazaInstaller" 
                                     Name="installed" 
                                     Type="integer" 
                                     Value="1" 
                                     KeyPath="yes" />
                        <!-- Clean up registry entries on uninstall -->
                        <RegistryKey Root="HKCU" Key="Software\Kamiwaza" ForceDeleteOnUninstall="yes" />
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <!-- DEB download is now handled directly within the Python installer -->

        <!-- Define the components -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <ComponentGroupRef Id="EmbeddedPythonFiles" />
            <ComponentRef Id="KamiwazaInstallerFiles" />
            <ComponentRef Id="ApplicationShortcut" />
        </ComponentGroup>

        <!-- Custom UI with memory configuration dialog -->
        <UIRef Id="WixUI_InstallDir" />
        
        <!-- Custom dialogs for user configuration -->
        <UI>
            <Dialog Id="KamiwazaConfigDlg" Width="370" Height="280" Title="Kamiwaza Configuration">
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Kamiwaza Configuration" />
                
                <!-- User Email -->
                <Control Id="EmailLabel" Type="Text" X="15" Y="35" Width="65" Height="12" NoPrefix="yes" Text="Email Address:" />
                <Control Id="EmailEdit" Type="Edit" X="85" Y="35" Width="200" Height="18" Property="USER_EMAIL" />
                
                <!-- License Key -->
                <Control Id="LicenseKeyLabel" Type="Text" X="15" Y="60" Width="65" Height="12" NoPrefix="yes" Text="License Key:" />
                <Control Id="LicenseKeyEdit" Type="Edit" X="85" Y="60" Width="200" Height="18" Property="LICENSE_KEY" />
                
                <!-- Usage Reporting -->
                <Control Id="UsageReportingLabel" Type="Text" X="15" Y="85" Width="340" Height="24" NoPrefix="yes" Text="Help improve Kamiwaza by sending anonymous usage analytics. This helps us understand feature usage and improve performance." />
                <Control Id="UsageReportingCheck" Type="CheckBox" X="15" Y="115" Width="200" Height="17" Property="USAGE_REPORTING" CheckBoxValue="1" Text="Enable usage reporting" />
                
                <!-- Installation Mode -->
                <Control Id="ModeLabel" Type="Text" X="15" Y="140" Width="100" Height="12" NoPrefix="yes" Text="Installation Mode:" />
                <Control Id="ModeCombo" Type="ComboBox" X="85" Y="140" Width="100" Height="18" Property="INSTALL_MODE" ComboList="yes">
                    <ComboBox Property="INSTALL_MODE">
                        <ListItem Text="Lite" Value="lite" />
                        <ListItem Text="Full" Value="full" />
                    </ComboBox>
                </Control>
                
                <!-- Memory Configuration with Dropdown -->
                <Control Id="MemoryLabel" Type="Text" X="15" Y="165" Width="140" Height="12" NoPrefix="yes" Text="Kamiwaza Dedicated Memory:" />
                <Control Id="MemoryCombo" Type="ComboBox" X="160" Y="165" Width="100" Height="18" Property="WSLMEMORY" ComboList="yes" Sorted="no">
                    <ComboBox Property="WSLMEMORY">
                        <ListItem Text=" 4GB" Value="4GB" />
                        <ListItem Text=" 6GB" Value="6GB" />
                        <ListItem Text=" 8GB" Value="8GB" />
                        <ListItem Text="10GB" Value="10GB" />
                        <ListItem Text="12GB" Value="12GB" />
                        <ListItem Text="14GB" Value="14GB" />
                        <ListItem Text="16GB" Value="16GB" />
                        <ListItem Text="20GB" Value="20GB" />
                        <ListItem Text="24GB" Value="24GB" />
                        <ListItem Text="28GB" Value="28GB" />
                        <ListItem Text="32GB" Value="32GB" />
                        <ListItem Text="48GB" Value="48GB" />
                        <ListItem Text="64GB" Value="64GB" />
                    </ComboBox>
                </Control>
                <Control Id="MemoryHelp" Type="Text" X="15" Y="185" Width="340" Height="24" NoPrefix="yes" Text="Select memory allocation for Kamiwaza. Higher values improve performance but use more system RAM. Your .wslconfig file will be automatically updated." />
                
                <!-- Navigation buttons -->
                <Control Id="Back" Type="PushButton" X="180" Y="253" Width="56" Height="17" Text="&amp;Back">
                    <Publish Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
                </Control>
                <Control Id="Next" Type="PushButton" X="236" Y="253" Width="56" Height="17" Default="yes" Text="&amp;Next">
                    <Publish Event="NewDialog" Value="InstallDirDlg">1</Publish>
                </Control>
                <Control Id="Cancel" Type="PushButton" X="304" Y="253" Width="56" Height="17" Cancel="yes" Text="Cancel">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>
            </Dialog>

            <!-- Custom Reboot Dialog -->
            <Dialog Id="KamiwazaRebootDlg" Width="370" Height="250" Title="Kamiwaza Installation Complete">
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Installation Complete!" />
                
                <Control Id="Message" Type="Text" X="15" Y="35" Width="340" Height="80" NoPrefix="yes" Text="Kamiwaza has been installed successfully! 

GPU acceleration has been configured and requires a system restart to activate properly.

*** WARNING: This will restart your ENTIRE computer, not just WSL.
   If you're working on a remote PC, please restart manually later.

For optimal performance, please restart your computer now." />
                
                <Control Id="RestartNow" Type="PushButton" X="15" Y="130" Width="120" Height="17" Default="yes" Text="Restart Now">
                    <Publish Event="Reboot" Value="now">1</Publish>
                </Control>
                
                <Control Id="RestartLater" Type="PushButton" X="145" Y="130" Width="120" Height="17" Text="Restart Later">
                    <Publish Event="NewDialog" Value="ExitDialog">1</Publish>
                </Control>
                
                <Control Id="Cancel" Type="PushButton" X="275" Y="130" Width="80" Height="17" Cancel="yes" Text="Cancel">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>
            </Dialog>

            <!-- Custom Exit Dialog with GUI Launch Option -->
            <Dialog Id="KamiwazaExitDlg" Width="370" Height="300" Title="Kamiwaza Setup Complete!">
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Setup Complete!" />
                
                <Control Id="Message" Type="Text" X="15" Y="35" Width="340" Height="80" NoPrefix="yes" Text="Kamiwaza has been installed successfully! 

The Kamiwaza installation will continue in a separate 'Kamiwaza Installer' window when you click Finish.

IMPORTANT: GPU acceleration has been configured but requires a MANUAL system restart to activate.

After installation completes:
• Access your deployment at https://localhost (or the URL shown in the installer output)
• For troubleshooting, run: wsl -d kamiwaza
• Use Start Menu shortcuts to manage your Kamiwaza platform
• To access Kamiwaza WSL instance directly: wsl -d kamiwaza
• GPU autostart has been configured using RunOnce registry (no admin rights required)
• Kamiwaza Monitor GUI has been installed for easy management" />
                
                <!-- GUI Launch Checkbox -->
                <Control Id="LaunchGUICheck" Type="CheckBox" X="15" Y="125" Width="340" Height="17" Property="LAUNCH_GUI" CheckBoxValue="1" Text="Launch Kamiwaza Diagnostic GUI when ready" />
                
                <Control Id="GUIHelp" Type="Text" X="15" Y="145" Width="340" Height="24" NoPrefix="yes" Text="The Diagnostic GUI will be installed by the Python installer. If checked, it will launch automatically once installation completes." />
                
                <!-- Navigation buttons -->
                <Control Id="Finish" Type="PushButton" X="236" Y="253" Width="56" Height="17" Default="yes" Text="&amp;Finish">
                    <Publish Event="EndDialog" Value="Return">1</Publish>
                </Control>
                
                <Control Id="Cancel" Type="PushButton" X="304" Y="253" Width="56" Height="17" Cancel="yes" Text="Cancel">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>
            </Dialog>

            <!-- Modify the InstallDirDlg to navigate to our custom dialog -->
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="KamiwazaConfigDlg" Order="2">LicenseAccepted = "1"</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="KamiwazaConfigDlg">1</Publish>
            
            <!-- Navigate to custom exit dialog after installation -->
            <Publish Dialog="ExitDialog" Control="Finish" Event="NewDialog" Value="KamiwazaExitDlg">1</Publish>
            
            <!-- Customize the exit dialog title and message -->
            <Property Id="WIXUI_EXITDIALOGTITLE" Value="Kamiwaza Setup Complete!" />
            <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Setup is complete! The Kamiwaza installation will continue in a separate 'Kamiwaza Installer' window when you click Finish.

IMPORTANT: GPU acceleration has been configured but requires a MANUAL system restart to activate.

After installation completes:
• Access your deployment at https://localhost (or the URL shown in the installer output)
• For troubleshooting, run: wsl -d kamiwaza
• Use Start Menu shortcuts to manage your Kamiwaza platform
• To access Kamiwaza WSL instance directly: wsl -d kamiwaza
• GPU autostart has been configured using RunOnce registry (no admin rights required)

*** RESTART REQUIRED: You will be prompted to restart your computer after clicking Finish.
   If you're working on a remote PC, please restart manually later." />
            
            <!-- Require user confirmation for reboot - no automatic restarts -->
            <Property Id="REBOOT" Value="ReallySuppress" />
            <Property Id="REBOOTPROMPT" Value="Suppress" />
        </UI>

        <!-- Safety check to prevent automatic restarts -->
        <CustomAction Id="CheckRemotePC"
                      ExeCommand='powershell.exe -Command "try { $isRemote = (Get-WmiObject -Class Win32_ComputerSystem).PrimaryOwnerName -ne $env:USERNAME; if ($isRemote) { Write-Host \"[WARNING]  REMOTE PC DETECTED: Please restart manually after installation completes.\" -ForegroundColor Yellow; Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show(\"[WARNING]  REMOTE PC DETECTED!`n`nThis appears to be a remote computer. Please restart manually after installation completes to avoid disconnection.`n`nClick OK to continue installation.\", \"Kamiwaza Remote PC Warning\", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Warning) } } catch { Write-Host \"Could not determine if remote PC - proceeding with caution\" }"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />
                      
        <!-- Custom Actions -->
        <CustomAction Id="DetectGPUCmd"
                      FileKey="GPUDetectionCMDScript"
                      ExeCommand=""
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />
                      
        <CustomAction Id="DetectGPU"
                      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLFOLDER]detect_gpu.ps1" -WSLDistribution "kamiwaza"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />
                      
        <CustomAction Id="RunKamiwazaInstaller" 
                      FileKey="KamiwazaBatchWrapper"
                      ExeCommand="--memory &quot;[WSLMEMORY]&quot; --email &quot;[USER_EMAIL]&quot; --license-key &quot;[LICENSE_KEY]&quot; --usage-reporting &quot;[USAGE_REPORTING]&quot; --mode &quot;[INSTALL_MODE]&quot;"
                      Execute="deferred" 
                      Impersonate="yes"
                      Return="ignore" />
        
        <!-- Reserve Kamiwaza ports on install -->
        <CustomAction Id="ReservePorts"
                      ExeCommand='powershell.exe -Command "try { 
        netsh int ipv4 add excludedportrange protocol=tcp startport=61100 numberofports=200 store=persistent | Out-Null
        Write-Host \"Reserved ports 61100-61299 for Kamiwaza\"
    } catch { 
        Write-Host \"Warning: Could not reserve ports (may already be reserved)\"
    }"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="no"
                      Return="ignore" />

        <!-- Comprehensive Cleanup Action for Uninstall - Complete removal of all Kamiwaza traces -->
        <CustomAction Id="ComprehensiveCleanup"
                      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLFOLDER]cleanup_installs.ps1" -Force'
                      Directory="TARGETDIR"
                      Execute="immediate"
                      Impersonate="yes"
                      Return="ignore" />

        <!-- Release Kamiwaza ports on uninstall -->
        <CustomAction Id="ReleasePorts"
                      ExeCommand='powershell.exe -Command "try { 
        netsh int ipv4 delete excludedportrange protocol=tcp startport=61100 numberofports=200 | Out-Null
        Write-Host \"Released ports 61100-61299\"
    } catch { 
        Write-Host \"Warning: Could not release ports (may not have been reserved)\"
    }"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="no"
                      Return="ignore" />

        <!-- Setup Autostart Registry Entry (alternative to Task Scheduler) -->
        <CustomAction Id="SetupAutostartRegistry"
                      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLFOLDER]create_autostart_registry.ps1"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />

        <!-- Install Kamiwaza GUI Manager to AppData and Start Menu -->
        <CustomAction Id="InstallGUIManager"
                      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLFOLDER]install_gui_manager.ps1"'
                      Directory="TARGETDIR"
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />

        <!-- Launch Kamiwaza Diagnostic GUI if requested -->
        <CustomAction Id="LaunchDiagnosticGUI"
                      ExeCommand='powershell.exe -Command "try { 
    $guiPath = \"$env:LOCALAPPDATA\Kamiwaza\GUI\KamiwazaGUIManager.exe\"; 
    $sourcePath = \"[INSTALLFOLDER]kamiwaza_gui_manager.py\";
    
    Write-Host \"=== KAMIWAZA DIAGNOSTIC GUI STATUS ===\";
    Write-Host \"Checking for Kamiwaza Diagnostic GUI...\";
    
    if (Test-Path $guiPath) { 
        Write-Host \"[OK] GUI found and ready to launch\";
        Write-Host \"Launching Kamiwaza Diagnostic GUI...\";
        Start-Process $guiPath;
        Write-Host \"[OK] Launched Kamiwaza Diagnostic GUI successfully\";
    } else { 
        Write-Host \"[INFO] GUI not found at: $guiPath\";
        Write-Host \"This is expected - the GUI Manager is installed by the Python installer phase\";
        Write-Host \"\";
        Write-Host \"The Python installer will:\";
        Write-Host \"1. Build the GUI Manager EXE\";
        Write-Host \"2. Install it to %LOCALAPPDATA%\\Kamiwaza\\GUI\\\";
        Write-Host \"3. Create Start Menu shortcuts\";
        Write-Host \"\";
        
        # Check if source files exist
        if (Test-Path $sourcePath) {
            Write-Host \"[OK] Source files found - GUI Manager will be installed\";
            Write-Host \"You can launch it later from: Start Menu > Kamiwaza > Kamiwaza GUI Manager\";
        } else {
            Write-Host \"[WARN] Source files not found - GUI Manager may not be included in this build\";
        }
        
        Write-Host \"\";
        Write-Host \"To access the GUI Manager after installation:\";
        Write-Host \"• Start Menu: Start > Kamiwaza > Kamiwaza GUI Manager\";
        Write-Host \"• Direct path: %LOCALAPPDATA%\\Kamiwaza\\GUI\\KamiwazaGUIManager.exe\";
    } 
} catch { 
    Write-Host \"Error checking GUI: $_\";
    Write-Host \"You can manually launch the GUI Manager from the Start Menu later\";
}"'
                      Directory="TARGETDIR"
                      Execute="immediate"
                      Impersonate="yes"
                      Return="ignore" />

        <!-- Auto-launch is now always enabled -->

        <!-- Install Execute Sequence - automatically run Kamiwaza installation -->
        <InstallExecuteSequence>
            <Custom Action="ReservePorts" After="InstallFiles">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="CheckRemotePC" After="ReservePorts">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="DetectGPUCmd" After="CheckRemotePC">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="RunKamiwazaInstaller" After="DetectGPUCmd">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="DetectGPU" After="RunKamiwazaInstaller">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="SetupAutostartRegistry" After="DetectGPU">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="InstallGUIManager" After="SetupAutostartRegistry">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="SetRunOnceEntry" After="InstallGUIManager">NOT Installed AND NOT REMOVE</Custom>
            <Custom Action="LaunchDiagnosticGUI" After="SetRunOnceEntry">NOT Installed AND NOT REMOVE AND LAUNCH_GUI = "1"</Custom>
            <Custom Action="ComprehensiveCleanup" Before="RemoveFiles">Installed AND REMOVE</Custom>
            <Custom Action="ReleasePorts" After="ComprehensiveCleanup">Installed AND REMOVE</Custom>
            
            <!-- Note: Reboot is handled by the custom dialog flow -->
        </InstallExecuteSequence>


        
        <!-- Reboot Continuation - Custom Action to set RunOnce entry -->
        <CustomAction Id="SetRunOnceEntry"
                      FileKey="CreateRunOnceBatch"
                      ExeCommand='"[INSTALLFOLDER]" "[WSLMEMORY]" "[USER_EMAIL]" "[LICENSE_KEY]" "[USAGE_REPORTING]" "[INSTALL_MODE]"'
                      Execute="deferred"
                      Impersonate="yes"
                      Return="ignore" />
    </Product>
</Wix> 